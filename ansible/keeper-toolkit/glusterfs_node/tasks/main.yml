---
- name: gluster repositories key trusted
  apt_key:
    url='http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.6/pub.key'
    state=present

- name: gluster repositories listed
  apt_repository:
    repo='deb http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.6/Debian/jessie/apt jessie main'
    state=present
    update_cache=yes

- name: gluster is installed
  apt:
    name={{ item }}
    state=present
  with_items:
    - glusterfs-server
    - glusterfs-client

- name: gluster service up and running
  service:
    name=glusterfs-server
    state=started
    enabled=yes

- name: gluster brick directory exists
  file:
    path={{ item.brick_dir }}
    state=directory
    mode=0775
  with_items: "{{ gluster_server_node.volumes }}"

- debug: msg="{{ groups.data_nodes | join(',') }}"
- name: gluster volume configured
  gluster_volume:
    name="{{ item.name }}"
    brick="{{ item.brick_dir }}"
    replicas="{{ item.replicas }}"
    cluster="{{ groups.data_nodes | join(',')}}"
    options="{{ item.options }}"
    host="{{ inventory_hostname }}"
    state=present
    force=yes
  with_items: "{{ gluster_server_node.volumes }}"
  run_once: true