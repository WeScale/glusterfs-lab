- hosts: all
  become: yes

  roles:
    - common
    - keeper

  tasks:
    - name: copy ssh key for data cluster management
      become: no
      copy:
        src="{{ keeper.data_nodes.ssh_key }}"
        dest='/home/cloud/.ssh/data-nodes.key.pem'
        mode=0600

    - name: ansible playbook for data cluster management
      become: no
      copy:
        src='./keeper-toolkit'
        dest='/home/cloud/'
      tags: push

    - name: creating ansible etc dir
      file:
        path=/etc/ansible
        state=directory
        owner=root
        group=root
        mode=0755

    - name: creating host inventory for data nodes
      template:
        src='templates/hosts.j2'
        dest='/etc/ansible/hosts'
      tags: push

    - name: generate ssh config for the data nodes
      template:
        src='templates/ssh_config.j2'
        dest='/home/cloud/keeper-toolkit/data_nodes_ssh_config'
        owner=cloud
        group=cloud
        mode=0600
      tags: push

- hosts: site_a
  become: yes

  tasks:
    - name: old-school enabling ipsec service
      shell: systemctl daemon-reload && /usr/sbin/update-rc.d ipsec defaults && /usr/sbin/update-rc.d ipsec enable

    - name: ipsec is up and ready
      service:
        name=ipsec
        state=restarted

- hosts: site_b
  become: yes

  tasks:
    - name: old-school enabling ipsec service
      shell: systemctl daemon-reload && /usr/sbin/update-rc.d ipsec defaults && /usr/sbin/update-rc.d ipsec enable

    - name: ipsec is up and ready
      service:
        name=ipsec
        state=restarted
